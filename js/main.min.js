document.addEventListener("DOMContentLoaded",()=>{const search=document.getElementById("searchInput"),grid=document.getElementById("grid"),genre=new URLSearchParams(window.location.search).get("genre")||"",sel=document.querySelector(`.dropdown-menu button[data-genre="${genre}"]`);if(sel){sel.classList.add("active");const gbtn=document.getElementById("genresBtn");if(gbtn)gbtn.textContent=genre+" ▾"}const fetchMovies=async()=>{try{const res=await fetch("api/movies.php");return await res.json()}catch(err){console.error("Error fetching movies:",err);return[]}};let items=[];const render=(it)=>{const a=document.createElement("article");a.className="card";a.innerHTML=`<div class="thumb"><img src="${it.cover_image}" alt="${it.title}" loading="lazy" width="270" height="405" style="display:block;width:100%;height:auto;object-fit:cover;"><div class="play-overlay"><span>▶</span></div></div><div class="meta"><h3 class="title">${it.title}</h3><p class="sub">${it.genre.join(" • ")}</p><p class="desc">${it.release_date}</p></div>`;a.addEventListener("click",()=>{const dialog=document.getElementById("player"),container=document.getElementById("playerContainer");if(container){try{while(container.firstChild)container.removeChild(container.firstChild)}catch(e){}const iframe=document.createElement("iframe");iframe.src=it.video_url;iframe.width="100%";iframe.height="100%";iframe.setAttribute("allow","accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture");iframe.setAttribute("frameborder","0");iframe.setAttribute("allowfullscreen","");iframe.style.border="0";container.appendChild(iframe)}try{dialog.showModal()}catch(e){dialog.setAttribute("open","")}});grid.appendChild(a)};const doFilter=(q)=>{const s=q.toLowerCase();grid.innerHTML="";items.filter(it=>it.title.toLowerCase().includes(s)||it.genre.some(g=>g.toLowerCase().includes(s))).forEach(render)};if(search)search.addEventListener("input",(e)=>doFilter(e.target.value));(async()=>{items=await fetchMovies();if(genre)items=items.filter(it=>it.genre.includes(genre));items.forEach(render)})();});